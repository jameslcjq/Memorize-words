import{c as st,g as ot,r as T,j as $,a as c,d as B,u as it,b as dt,e as at,i as ct,f as lt,h as et,L as ut,t as ht,$ as ft,k as gt,F as mt,l as yt,m as pt,n as wt}from"./index-0b56841e.js";const bt="_calendarCard_1anbv_2",vt="_header_1anbv_21",$t="_subText_1anbv_37",xt="_navBtn_1anbv_45",Dt="_gridHeader_1anbv_64",Mt="_daysContainer_1anbv_74",St="_day_1anbv_74",kt="_checked_1anbv_98",_t="_empty_1anbv_103",Nt="_today_1anbv_121",Ct="_selected_1anbv_124",A={calendarCard:bt,header:vt,subText:$t,navBtn:xt,gridHeader:Dt,daysContainer:Mt,day:St,checked:kt,empty:_t,today:Nt,selected:Ct};var rt={exports:{}};(function(i,y){(function(M,v){i.exports=v()})(st,function(){var M=1e3,v=6e4,C=36e5,k="millisecond",_="second",h="minute",l="hour",m="day",O="week",b="month",r="quarter",x="year",f="date",u="Invalid Date",g=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,H=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,F={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(n){var a=["th","st","nd","rd"],t=n%100;return"["+n+(a[(t-20)%10]||a[t]||a[0])+"]"}},U=function(n,a,t){var s=String(n);return!s||s.length>=a?n:""+Array(a+1-s.length).join(t)+n},G={s:U,z:function(n){var a=-n.utcOffset(),t=Math.abs(a),s=Math.floor(t/60),e=t%60;return(a<=0?"+":"-")+U(s,2,"0")+":"+U(e,2,"0")},m:function n(a,t){if(a.date()<t.date())return-n(t,a);var s=12*(t.year()-a.year())+(t.month()-a.month()),e=a.clone().add(s,b),d=t-e<0,o=a.clone().add(s+(d?-1:1),b);return+(-(s+(t-e)/(d?e-o:o-e))||0)},a:function(n){return n<0?Math.ceil(n)||0:Math.floor(n)},p:function(n){return{M:b,y:x,w:O,d:m,D:f,h:l,m:h,s:_,ms:k,Q:r}[n]||String(n||"").toLowerCase().replace(/s$/,"")},u:function(n){return n===void 0}},J="en",R={};R[J]=F;var Q=function(n){return n instanceof K},z=function n(a,t,s){var e;if(!a)return J;if(typeof a=="string"){var d=a.toLowerCase();R[d]&&(e=d),t&&(R[d]=t,e=d);var o=a.split("-");if(!e&&o.length>1)return n(o[0])}else{var w=a.name;R[w]=a,e=w}return!s&&e&&(J=e),e||!s&&J},N=function(n,a){if(Q(n))return n.clone();var t=typeof a=="object"?a:{};return t.date=n,t.args=arguments,new K(t)},p=G;p.l=z,p.i=Q,p.w=function(n,a){return N(n,{locale:a.$L,utc:a.$u,x:a.$x,$offset:a.$offset})};var K=function(){function n(t){this.$L=z(t.locale,null,!0),this.parse(t)}var a=n.prototype;return a.parse=function(t){this.$d=function(s){var e=s.date,d=s.utc;if(e===null)return new Date(NaN);if(p.u(e))return new Date;if(e instanceof Date)return new Date(e);if(typeof e=="string"&&!/Z$/i.test(e)){var o=e.match(g);if(o){var w=o[2]-1||0,S=(o[7]||"0").substring(0,3);return d?new Date(Date.UTC(o[1],w,o[3]||1,o[4]||0,o[5]||0,o[6]||0,S)):new Date(o[1],w,o[3]||1,o[4]||0,o[5]||0,o[6]||0,S)}}return new Date(e)}(t),this.$x=t.x||{},this.init()},a.init=function(){var t=this.$d;this.$y=t.getFullYear(),this.$M=t.getMonth(),this.$D=t.getDate(),this.$W=t.getDay(),this.$H=t.getHours(),this.$m=t.getMinutes(),this.$s=t.getSeconds(),this.$ms=t.getMilliseconds()},a.$utils=function(){return p},a.isValid=function(){return this.$d.toString()!==u},a.isSame=function(t,s){var e=N(t);return this.startOf(s)<=e&&e<=this.endOf(s)},a.isAfter=function(t,s){return N(t)<this.startOf(s)},a.isBefore=function(t,s){return this.endOf(s)<N(t)},a.$g=function(t,s,e){return p.u(t)?this[s]:this.set(e,t)},a.unix=function(){return Math.floor(this.valueOf()/1e3)},a.valueOf=function(){return this.$d.getTime()},a.startOf=function(t,s){var e=this,d=!!p.u(s)||s,o=p.p(t),w=function(P,j){var E=p.w(e.$u?Date.UTC(e.$y,j,P):new Date(e.$y,j,P),e);return d?E:E.endOf(m)},S=function(P,j){return p.w(e.toDate()[P].apply(e.toDate("s"),(d?[0,0,0,0]:[23,59,59,999]).slice(j)),e)},D=this.$W,Y=this.$M,L=this.$D,I="set"+(this.$u?"UTC":"");switch(o){case x:return d?w(1,0):w(31,11);case b:return d?w(1,Y):w(0,Y+1);case O:var V=this.$locale().weekStart||0,Z=(D<V?D+7:D)-V;return w(d?L-Z:L+(6-Z),Y);case m:case f:return S(I+"Hours",0);case l:return S(I+"Minutes",1);case h:return S(I+"Seconds",2);case _:return S(I+"Milliseconds",3);default:return this.clone()}},a.endOf=function(t){return this.startOf(t,!1)},a.$set=function(t,s){var e,d=p.p(t),o="set"+(this.$u?"UTC":""),w=(e={},e[m]=o+"Date",e[f]=o+"Date",e[b]=o+"Month",e[x]=o+"FullYear",e[l]=o+"Hours",e[h]=o+"Minutes",e[_]=o+"Seconds",e[k]=o+"Milliseconds",e)[d],S=d===m?this.$D+(s-this.$W):s;if(d===b||d===x){var D=this.clone().set(f,1);D.$d[w](S),D.init(),this.$d=D.set(f,Math.min(this.$D,D.daysInMonth())).$d}else w&&this.$d[w](S);return this.init(),this},a.set=function(t,s){return this.clone().$set(t,s)},a.get=function(t){return this[p.p(t)]()},a.add=function(t,s){var e,d=this;t=Number(t);var o=p.p(s),w=function(Y){var L=N(d);return p.w(L.date(L.date()+Math.round(Y*t)),d)};if(o===b)return this.set(b,this.$M+t);if(o===x)return this.set(x,this.$y+t);if(o===m)return w(1);if(o===O)return w(7);var S=(e={},e[h]=v,e[l]=C,e[_]=M,e)[o]||1,D=this.$d.getTime()+t*S;return p.w(D,this)},a.subtract=function(t,s){return this.add(-1*t,s)},a.format=function(t){var s=this,e=this.$locale();if(!this.isValid())return e.invalidDate||u;var d=t||"YYYY-MM-DDTHH:mm:ssZ",o=p.z(this),w=this.$H,S=this.$m,D=this.$M,Y=e.weekdays,L=e.months,I=function(j,E,X,q){return j&&(j[E]||j(s,d))||X[E].slice(0,q)},V=function(j){return p.s(w%12||12,j,"0")},Z=e.meridiem||function(j,E,X){var q=j<12?"AM":"PM";return X?q.toLowerCase():q},P={YY:String(this.$y).slice(-2),YYYY:p.s(this.$y,4,"0"),M:D+1,MM:p.s(D+1,2,"0"),MMM:I(e.monthsShort,D,L,3),MMMM:I(L,D),D:this.$D,DD:p.s(this.$D,2,"0"),d:String(this.$W),dd:I(e.weekdaysMin,this.$W,Y,2),ddd:I(e.weekdaysShort,this.$W,Y,3),dddd:Y[this.$W],H:String(w),HH:p.s(w,2,"0"),h:V(1),hh:V(2),a:Z(w,S,!0),A:Z(w,S,!1),m:String(S),mm:p.s(S,2,"0"),s:String(this.$s),ss:p.s(this.$s,2,"0"),SSS:p.s(this.$ms,3,"0"),Z:o};return d.replace(H,function(j,E){return E||P[j]||o.replace(":","")})},a.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},a.diff=function(t,s,e){var d,o=p.p(s),w=N(t),S=(w.utcOffset()-this.utcOffset())*v,D=this-w,Y=p.m(this,w);return Y=(d={},d[x]=Y/12,d[b]=Y,d[r]=Y/3,d[O]=(D-S)/6048e5,d[m]=(D-S)/864e5,d[l]=D/C,d[h]=D/v,d[_]=D/M,d)[o]||D,e?Y:p.a(Y)},a.daysInMonth=function(){return this.endOf(b).$D},a.$locale=function(){return R[this.$L]},a.locale=function(t,s){if(!t)return this.$L;var e=this.clone(),d=z(t,s,!0);return d&&(e.$L=d),e},a.clone=function(){return p.w(this.$d,this)},a.toDate=function(){return new Date(this.valueOf())},a.toJSON=function(){return this.isValid()?this.toISOString():null},a.toISOString=function(){return this.$d.toISOString()},a.toString=function(){return this.$d.toUTCString()},n}(),tt=K.prototype;return N.prototype=tt,[["$ms",k],["$s",_],["$m",h],["$H",l],["$W",m],["$M",b],["$y",x],["$D",f]].forEach(function(n){tt[n[1]]=function(a){return this.$g(a,n[0],n[1])}}),N.extend=function(n,a){return n.$i||(n(a,K,N),n.$i=!0),N},N.locale=z,N.isDayjs=Q,N.unix=function(n){return N(1e3*n)},N.en=R[J],N.Ls=R,N.p={},N})})(rt);var Yt=rt.exports;const W=ot(Yt);globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(i,y){return this.cache.has(i)?this.cache.get(i):(this.cache.set(i,y),y)}};const Ot=({practicedDates:i,onDateSelect:y,selectedDate:M})=>{const[v,C]=T.useState(new Date),[k,_]=T.useState({});T.useEffect(()=>{const r={};i.forEach(x=>{r[x]=!0}),_(r)},[i]);const h=v.getFullYear(),l=v.getMonth(),m=r=>{C(new Date(h,l+r,1))},O=()=>{const r=new Date(h,l+1,0).getDate();let x=0;for(let f=1;f<=r;f++){const u=W(new Date(h,l,f)).format("YYYY-MM-DD");k[u]&&x++}return x},b=()=>{const r=new Date(h,l+1,0).getDate(),x=new Date(h,l,1).getDay(),f=W().format("YYYY-MM-DD"),u=[];for(let g=0;g<x;g++)u.push(c("div",{className:A.day+" "+A.empty},`empty-${g}`));for(let g=1;g<=r;g++){const H=new Date(h,l,g),F=W(H).format("YYYY-MM-DD"),U=!!k[F],G=F===f,J=M===F;let R=A.day;U&&(R+=` ${A.checked}`),G&&(R+=` ${A.today}`),J&&(R+=` ${A.selected}`),u.push(c("div",{className:R,onClick:()=>y(F),children:g},F))}return u};return $("div",{className:A.calendarCard,children:[$("header",{className:A.header,children:[c("button",{className:A.navBtn,onClick:()=>m(-1),children:"❮"}),$("h2",{children:[$("span",{children:[h,"年 ",l+1,"月"]}),$("span",{className:A.subText,children:["本月已坚持 ",O()," 天"]})]}),c("button",{className:A.navBtn,onClick:()=>m(1),children:"❯"})]}),$("div",{className:A.gridHeader,children:[c("div",{children:"日"}),c("div",{children:"一"}),c("div",{children:"二"}),c("div",{children:"三"}),c("div",{children:"四"}),c("div",{children:"五"}),c("div",{children:"六"})]}),c("div",{className:A.daysContainer,children:b()})]})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(i,y){return this.cache.has(i)?this.cache.get(i):(this.cache.set(i,y),y)}};function jt(i,y){const M=[];let v=W(i).startOf("day");const C=W(y).endOf("day");for(;v.diff(C)<0;)M.push(v.clone().format("YYYY-MM-DD")),v=v.add(1,"day");return M}function nt(i,y){const[M,v]=T.useState({stats:{all:[],typing:[],"word-to-trans":[],"trans-to-word":[]}});return T.useEffect(()=>{(async()=>{const k=await Wt(i,y);v(k)})()},[i,y]),M}async function Wt(i,y){const M=await B.wordRecords.where("timeStamp").between(i,y).toArray();if(M.length===0)return{isEmpty:!0,stats:{all:[],typing:[],"word-to-trans":[],"trans-to-word":[]}};const v=h=>h.map(l=>({[l]:{words:[],wrongWordsList:[],totalDuration:0,moduleDurations:{}}})).reduce((l,m)=>({...l,...m}),{}),C=jt(i*1e3,y*1e3),k={all:v(C),typing:v(C),"word-to-trans":v(C),"trans-to-word":v(C)};for(let h=0;h<M.length;h++){const l=M[h],m=W(l.timeStamp*1e3).format("YYYY-MM-DD"),O=l.mode||"typing",b=(l.timing||[]).reduce((f,u)=>f+u,0),r=f=>{f[m]&&(f[m].words.push(l.word),l.wrongCount>0&&f[m].wrongWordsList.push(l.word),f[m].totalDuration+=b,x(f[m].moduleDurations,O,b))},x=(f,u,g)=>{f[u]||(f[u]=0),f[u]+=g};r(k.all),k[O]&&r(k[O])}const _=h=>Object.entries(h).map(([l,{words:m,wrongWordsList:O,totalDuration:b,moduleDurations:r}])=>({date:l,totalWordsCount:m.length,practicedWords:m,wrongWords:Array.from(new Set(O)),duration:Math.round(b/1e3/60),moduleDurations:Object.fromEntries(Object.entries(r).map(([x,f])=>[x,Math.round(f/1e3/60)]))})).filter(l=>l.totalWordsCount>0).sort((l,m)=>W(l.date).isBefore(W(m.date))?1:-1);return{stats:{all:_(k.all),typing:_(k.typing),"word-to-trans":_(k["word-to-trans"]),"trans-to-word":_(k["trans-to-word"])}}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(i,y){return this.cache.has(i)?this.cache.get(i):(this.cache.set(i,y),y)}};const At=()=>{const i=it(dt),[y,M]=at(ct),[v,C]=T.useState([]),k=W().subtract(1,"year").unix(),_=W().unix(),{stats:h}=nt(k,_),l=T.useCallback(async()=>{if(!i)return;const b=(h==null?void 0:h.all.map(u=>({date:u.date,duration:u.duration||0,wordCount:u.totalWordsCount})))||[],r=await B.wordRecords.toArray(),x=await B.chapterRecords.toArray(),f={userId:i.userId,records:b,wordRecords:r,chapterRecords:x};await fetch("/api/sync/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(f)})},[i,h]),m=T.useCallback(async()=>{if(!i)return;const b=await fetch(`/api/sync/download?userId=${i.userId}`);if(b.ok){const r=await b.json();r.success&&(C(r.data),(r.wordRecords||r.chapterRecords)&&await B.transaction("rw",B.wordRecords,B.chapterRecords,async()=>{r.wordRecords&&r.wordRecords.length>0&&await B.wordRecords.bulkPut(r.wordRecords),r.chapterRecords&&r.chapterRecords.length>0&&await B.chapterRecords.bulkPut(r.chapterRecords)}))}},[i]);return{syncData:T.useCallback(async()=>{if(!(!i||y)){M(!0);try{await Promise.all([l(),m()])}catch{}finally{M(!1)}}},[i,y,l,m]),isSyncing:y,cloudStats:v,localStats:(h==null?void 0:h.all)||[]}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(i,y){return this.cache.has(i)?this.cache.get(i):(this.cache.set(i,y),y)}};const Rt=()=>{const i=lt(),[,y]=at(wt),[M,v]=T.useState(W().format("YYYY-MM-DD")),{syncData:C,isSyncing:k,cloudStats:_,localStats:h}=At();T.useEffect(()=>{C()},[C]);const l=T.useCallback(()=>{i("/")},[i]),m=()=>{y(u=>!u)};et("ctrl+d",()=>{m()},{enableOnFormTags:!0,preventDefault:!0},[]),et("enter,esc",l,{preventDefault:!0});const{isEmpty:O}=nt(W().subtract(1,"year").unix(),W().unix()),b=T.useMemo(()=>{const u=new Map;return h.forEach(g=>u.set(g.date,{...g})),_.forEach(g=>{const H=u.get(g.date);H?(H.totalWordsCount=Math.max(H.totalWordsCount,g.wordCount),H.duration=Math.max(H.duration,g.duration)):u.set(g.date,{date:g.date,totalWordsCount:g.wordCount,duration:g.duration,practicedWords:[],wrongWords:[],moduleDurations:{}})}),Array.from(u.values())},[h,_]),r=b.find(u=>u.date===M),x=b.map(u=>u.date),f={typing:"背默单词","word-to-trans":"英译中","trans-to-word":"中译英"};return c(ut,{children:$("div",{className:"flex w-full flex-1 flex-col overflow-y-auto pl-20 pr-20 pt-20",children:[c(ht,{className:"absolute right-20 top-10 mr-2 h-7 w-7 cursor-pointer text-gray-400",onClick:l}),$(ft,{className:"flex-1 overflow-y-auto",children:[c(gt,{className:"h-full w-auto pb-[20rem] [&>div]:!block",children:O?c("div",{className:"align-items-center m-4 grid h-80 w-auto place-content-center overflow-hidden rounded-lg shadow-lg dark:bg-gray-600",children:c("div",{className:"text-2xl text-gray-400",children:"暂无练习数据"})}):c(mt,{children:$("div",{className:"mx-4 my-8 h-auto w-auto overflow-hidden rounded-lg p-8 shadow-lg dark:bg-gray-700 dark:bg-opacity-50",children:[c("div",{className:"mb-4 flex justify-end",children:c(yt,{})}),c("div",{className:"flex justify-center",children:c(Ot,{practicedDates:x,selectedDate:M,onDateSelect:v})}),$("div",{className:"mt-8 border-t border-gray-200 pt-8 dark:border-gray-600",children:[$("h2",{className:"mb-6 text-xl font-bold text-gray-700 dark:text-gray-200",children:[M," 练习详情"]}),r?c("div",{className:"flex flex-col gap-6",children:$("div",{className:"rounded-xl border border-gray-200 bg-white/50 p-6 dark:border-gray-600 dark:bg-gray-800/50",children:[$("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-4 border-b border-gray-100 pb-4 dark:border-gray-700",children:[$("div",{className:"flex items-center gap-3",children:[c("span",{className:"text-lg font-bold text-indigo-500",children:r.date}),c("span",{className:"rounded-full bg-indigo-100 px-3 py-1 text-xs font-medium text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-300",children:W(r.date).format("dddd")})]}),$("div",{className:"flex gap-4 text-sm text-gray-500 dark:text-gray-400",children:[$("span",{children:["总时长:"," ",$("span",{className:"font-semibold text-gray-900 dark:text-gray-200",children:[r.duration," 分钟"]})]}),$("span",{children:["总词数:"," ",c("span",{className:"font-semibold text-gray-900 dark:text-gray-200",children:r.totalWordsCount})]}),$("span",{children:["错词数: ",c("span",{className:"font-semibold text-red-500",children:r.wrongWords.length})]})]})]}),r.moduleDurations&&Object.keys(r.moduleDurations).length>0&&$("div",{className:"mb-4",children:[c("span",{className:"mb-2 block text-sm font-semibold text-gray-600 dark:text-gray-300",children:"模块时长"}),c("div",{className:"flex flex-wrap gap-2",children:Object.entries(r.moduleDurations).map(([u,g])=>g>0&&$("span",{className:"rounded-md bg-blue-50 px-2 py-1 text-sm text-blue-600 ring-1 ring-inset ring-blue-500/10 dark:bg-blue-900/20 dark:text-blue-400 dark:ring-blue-500/20",children:[f[u]||u,": ",g," 分钟"]},`duration-${u}`))})]}),r.wrongWords.length>0&&$("div",{className:"mb-4",children:[c("span",{className:"mb-2 block text-sm font-semibold text-red-500",children:"错词列表"}),c("div",{className:"flex flex-wrap gap-2",children:r.wrongWords.map((u,g)=>c("span",{className:"rounded-md bg-red-50 px-2 py-1 text-sm text-red-600 ring-1 ring-inset ring-red-500/10 dark:bg-red-900/20 dark:text-red-400 dark:ring-red-500/20",children:u},`${r.date}-wrong-${g}`))})]}),c("div",{children:$("details",{className:"group",children:[$("summary",{className:"flex cursor-pointer items-center gap-2 text-sm font-semibold text-gray-600 transition-colors hover:text-indigo-600 dark:text-gray-300 dark:hover:text-indigo-400",children:[c("span",{className:"transition-transform duration-200 group-open:rotate-90",children:"▶"}),"练习单词列表 (",r.practicedWords.length,")"]}),c("div",{className:"mt-3 flex flex-wrap gap-2 pl-4",children:r.practicedWords.map((u,g)=>c("span",{className:"rounded-md bg-gray-100 px-2 py-1 text-sm text-gray-600 dark:bg-gray-700 dark:text-gray-300",children:u},`${r.date}-word-${g}`))})]})})]},r.date)}):c("div",{className:"py-10 text-center text-gray-500 dark:text-gray-400",children:"该日期无练习记录"})]})]})})}),c(pt,{className:"flex touch-none select-none bg-transparent ",orientation:"vertical"})]}),c("div",{className:"overflow-y-auto"})]})})};export{Rt as default};
