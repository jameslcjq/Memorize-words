import{r as x,j as c,a as e,d as f,b as D,u as $,c as A,e as _,i as R,f as O,g as M,L as T,t as E,$ as I,h as B,F as H,k as L,l as F,m as P}from"./index-db669e73.js";const K="_calendarCard_1anbv_2",J="_header_1anbv_21",V="_subText_1anbv_37",X="_navBtn_1anbv_45",q="_gridHeader_1anbv_64",z="_daysContainer_1anbv_74",G="_day_1anbv_74",Q="_checked_1anbv_98",U="_empty_1anbv_103",Z="_today_1anbv_121",tt="_selected_1anbv_124",b={calendarCard:K,header:J,subText:V,navBtn:X,gridHeader:q,daysContainer:z,day:G,checked:Q,empty:U,today:Z,selected:tt};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(a,o){return this.cache.has(a)?this.cache.get(a):(this.cache.set(a,o),o)}};const et=({practicedDates:a,onDateSelect:o,selectedDate:u})=>{const[h,p]=x.useState(new Date),[g,w]=x.useState({});x.useEffect(()=>{const t={};a.forEach(y=>{t[y]=!0}),w(t)},[a]);const d=h.getFullYear(),s=h.getMonth(),l=t=>{p(new Date(d,s+t,1))},v=()=>{const t=new Date(d,s+1,0).getDate();let y=0;for(let i=1;i<=t;i++){const r=f(new Date(d,s,i)).format("YYYY-MM-DD");g[r]&&y++}return y},m=()=>{const t=new Date(d,s+1,0).getDate(),y=new Date(d,s,1).getDay(),i=f().format("YYYY-MM-DD"),r=[];for(let n=0;n<y;n++)r.push(e("div",{className:b.day+" "+b.empty},`empty-${n}`));for(let n=1;n<=t;n++){const k=new Date(d,s,n),N=f(k).format("YYYY-MM-DD"),Y=!!g[N],j=N===i,W=u===N;let C=b.day;Y&&(C+=` ${b.checked}`),j&&(C+=` ${b.today}`),W&&(C+=` ${b.selected}`),r.push(e("div",{className:C,onClick:()=>o(N),children:n},N))}return r};return c("div",{className:b.calendarCard,children:[c("header",{className:b.header,children:[e("button",{className:b.navBtn,onClick:()=>l(-1),children:"❮"}),c("h2",{children:[c("span",{children:[d,"年 ",s+1,"月"]}),c("span",{className:b.subText,children:["本月已坚持 ",v()," 天"]})]}),e("button",{className:b.navBtn,onClick:()=>l(1),children:"❯"})]}),c("div",{className:b.gridHeader,children:[e("div",{children:"日"}),e("div",{children:"一"}),e("div",{children:"二"}),e("div",{children:"三"}),e("div",{children:"四"}),e("div",{children:"五"}),e("div",{children:"六"})]}),e("div",{className:b.daysContainer,children:m()})]})};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(a,o){return this.cache.has(a)?this.cache.get(a):(this.cache.set(a,o),o)}};function at(a,o){const u=[];let h=f(a).startOf("day");const p=f(o).endOf("day");for(;h.diff(p)<0;)u.push(h.clone().format("YYYY-MM-DD")),h=h.add(1,"day");return u}function S(a,o){const[u,h]=x.useState({stats:{all:[],typing:[],"word-to-trans":[],"trans-to-word":[]}});return x.useEffect(()=>{(async()=>{const g=await rt(a,o);h(g)})()},[a,o]),u}async function rt(a,o){const u=await D.wordRecords.where("timeStamp").between(a,o).toArray();if(u.length===0)return{isEmpty:!0,stats:{all:[],typing:[],"word-to-trans":[],"trans-to-word":[]}};const h=d=>d.map(s=>({[s]:{words:[],wrongWordsList:[],totalDuration:0,moduleDurations:{}}})).reduce((s,l)=>({...s,...l}),{}),p=at(a*1e3,o*1e3),g={all:h(p),typing:h(p),"word-to-trans":h(p),"trans-to-word":h(p)};for(let d=0;d<u.length;d++){const s=u[d],l=f(s.timeStamp*1e3).format("YYYY-MM-DD"),v=s.mode||"typing",m=(s.timing||[]).reduce((i,r)=>i+r,0),t=i=>{i[l]&&(i[l].words.push(s.word),s.wrongCount>0&&i[l].wrongWordsList.push(s.word),i[l].totalDuration+=m,y(i[l].moduleDurations,v,m))},y=(i,r,n)=>{i[r]||(i[r]=0),i[r]+=n};t(g.all),g[v]&&t(g[v])}const w=d=>Object.entries(d).map(([s,{words:l,wrongWordsList:v,totalDuration:m,moduleDurations:t}])=>({date:s,totalWordsCount:l.length,practicedWords:l,wrongWords:Array.from(new Set(v)),duration:Math.round(m/1e3/60),moduleDurations:Object.fromEntries(Object.entries(t).map(([y,i])=>[y,Math.round(i/1e3/60)]))})).filter(s=>s.totalWordsCount>0).sort((s,l)=>f(s.date).isBefore(f(l.date))?1:-1);return{stats:{all:w(g.all),typing:w(g.typing),"word-to-trans":w(g["word-to-trans"]),"trans-to-word":w(g["trans-to-word"])}}}globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(a,o){return this.cache.has(a)?this.cache.get(a):(this.cache.set(a,o),o)}};const st=()=>{const a=$(A),[o,u]=_(R),[h,p]=x.useState([]),g=f().subtract(1,"year").unix(),w=f().unix(),{stats:d}=S(g,w),s=x.useCallback(async()=>{if(!a)return;const m=(d==null?void 0:d.all.map(r=>({date:r.date,duration:r.duration||0,wordCount:r.totalWordsCount})))||[],t=await D.wordRecords.toArray(),y=await D.chapterRecords.toArray(),i={userId:a.userId,records:m,wordRecords:t,chapterRecords:y};await fetch("/api/sync/upload",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(i)})},[a,d]),l=x.useCallback(async()=>{if(!a)return;const m=await fetch(`/api/sync/download?userId=${a.userId}`);if(m.ok){const t=await m.json();t.success&&(p(t.data),(t.wordRecords||t.chapterRecords)&&await D.transaction("rw",D.wordRecords,D.chapterRecords,async()=>{t.wordRecords&&t.wordRecords.length>0&&await D.wordRecords.bulkPut(t.wordRecords),t.chapterRecords&&t.chapterRecords.length>0&&await D.chapterRecords.bulkPut(t.chapterRecords)}))}},[a]);return{syncData:x.useCallback(async()=>{if(!(!a||o)){u(!0);try{await Promise.all([s(),l()])}catch{}finally{u(!1)}}},[a,o,s,l]),isSyncing:o,cloudStats:h,localStats:(d==null?void 0:d.all)||[]}};globalThis.jotaiAtomCache=globalThis.jotaiAtomCache||{cache:new Map,get(a,o){return this.cache.has(a)?this.cache.get(a):(this.cache.set(a,o),o)}};const ot=()=>{const a=O(),[,o]=_(P),[u,h]=x.useState(f().format("YYYY-MM-DD")),{syncData:p,isSyncing:g,cloudStats:w,localStats:d}=st();x.useEffect(()=>{p()},[p]);const s=x.useCallback(()=>{a("/")},[a]),l=()=>{o(r=>!r)};M("ctrl+d",()=>{l()},{enableOnFormTags:!0,preventDefault:!0},[]),M("enter,esc",s,{preventDefault:!0});const{isEmpty:v}=S(f().subtract(1,"year").unix(),f().unix()),m=x.useMemo(()=>{const r=new Map;return d.forEach(n=>r.set(n.date,{...n})),w.forEach(n=>{const k=r.get(n.date);k?(k.totalWordsCount=Math.max(k.totalWordsCount,n.wordCount),k.duration=Math.max(k.duration,n.duration)):r.set(n.date,{date:n.date,totalWordsCount:n.wordCount,duration:n.duration,practicedWords:[],wrongWords:[],moduleDurations:{}})}),Array.from(r.values())},[d,w]),t=m.find(r=>r.date===u),y=m.map(r=>r.date),i={typing:"背默单词","word-to-trans":"英译中","trans-to-word":"中译英"};return e(T,{children:c("div",{className:"flex w-full flex-1 flex-col overflow-y-auto pl-20 pr-20 pt-20",children:[e(E,{className:"absolute right-20 top-10 mr-2 h-7 w-7 cursor-pointer text-gray-400",onClick:s}),c(I,{className:"flex-1 overflow-y-auto",children:[e(B,{className:"h-full w-auto pb-[20rem] [&>div]:!block",children:v?e("div",{className:"align-items-center m-4 grid h-80 w-auto place-content-center overflow-hidden rounded-lg shadow-lg dark:bg-gray-600",children:e("div",{className:"text-2xl text-gray-400",children:"暂无练习数据"})}):e(H,{children:c("div",{className:"mx-4 my-8 h-auto w-auto overflow-hidden rounded-lg p-8 shadow-lg dark:bg-gray-700 dark:bg-opacity-50",children:[e("div",{className:"mb-4 flex justify-end",children:e(L,{})}),e("div",{className:"flex justify-center",children:e(et,{practicedDates:y,selectedDate:u,onDateSelect:h})}),c("div",{className:"mt-8 border-t border-gray-200 pt-8 dark:border-gray-600",children:[c("h2",{className:"mb-6 text-xl font-bold text-gray-700 dark:text-gray-200",children:[u," 练习详情"]}),t?e("div",{className:"flex flex-col gap-6",children:c("div",{className:"rounded-xl border border-gray-200 bg-white/50 p-6 dark:border-gray-600 dark:bg-gray-800/50",children:[c("div",{className:"mb-4 flex flex-wrap items-center justify-between gap-4 border-b border-gray-100 pb-4 dark:border-gray-700",children:[c("div",{className:"flex items-center gap-3",children:[e("span",{className:"text-lg font-bold text-indigo-500",children:t.date}),e("span",{className:"rounded-full bg-indigo-100 px-3 py-1 text-xs font-medium text-indigo-600 dark:bg-indigo-900/30 dark:text-indigo-300",children:f(t.date).format("dddd")})]}),c("div",{className:"flex gap-4 text-sm text-gray-500 dark:text-gray-400",children:[c("span",{children:["总时长:"," ",c("span",{className:"font-semibold text-gray-900 dark:text-gray-200",children:[t.duration," 分钟"]})]}),c("span",{children:["总词数:"," ",e("span",{className:"font-semibold text-gray-900 dark:text-gray-200",children:t.totalWordsCount})]}),c("span",{children:["错词数: ",e("span",{className:"font-semibold text-red-500",children:t.wrongWords.length})]})]})]}),t.moduleDurations&&Object.keys(t.moduleDurations).length>0&&c("div",{className:"mb-4",children:[e("span",{className:"mb-2 block text-sm font-semibold text-gray-600 dark:text-gray-300",children:"模块时长"}),e("div",{className:"flex flex-wrap gap-2",children:Object.entries(t.moduleDurations).map(([r,n])=>n>0&&c("span",{className:"rounded-md bg-blue-50 px-2 py-1 text-sm text-blue-600 ring-1 ring-inset ring-blue-500/10 dark:bg-blue-900/20 dark:text-blue-400 dark:ring-blue-500/20",children:[i[r]||r,": ",n," 分钟"]},`duration-${r}`))})]}),t.wrongWords.length>0&&c("div",{className:"mb-4",children:[e("span",{className:"mb-2 block text-sm font-semibold text-red-500",children:"错词列表"}),e("div",{className:"flex flex-wrap gap-2",children:t.wrongWords.map((r,n)=>e("span",{className:"rounded-md bg-red-50 px-2 py-1 text-sm text-red-600 ring-1 ring-inset ring-red-500/10 dark:bg-red-900/20 dark:text-red-400 dark:ring-red-500/20",children:r},`${t.date}-wrong-${n}`))})]}),e("div",{children:c("details",{className:"group",children:[c("summary",{className:"flex cursor-pointer items-center gap-2 text-sm font-semibold text-gray-600 transition-colors hover:text-indigo-600 dark:text-gray-300 dark:hover:text-indigo-400",children:[e("span",{className:"transition-transform duration-200 group-open:rotate-90",children:"▶"}),"练习单词列表 (",t.practicedWords.length,")"]}),e("div",{className:"mt-3 flex flex-wrap gap-2 pl-4",children:t.practicedWords.map((r,n)=>e("span",{className:"rounded-md bg-gray-100 px-2 py-1 text-sm text-gray-600 dark:bg-gray-700 dark:text-gray-300",children:r},`${t.date}-word-${n}`))})]})})]},t.date)}):e("div",{className:"py-10 text-center text-gray-500 dark:text-gray-400",children:"该日期无练习记录"})]})]})})}),e(F,{className:"flex touch-none select-none bg-transparent ",orientation:"vertical"})]}),e("div",{className:"overflow-y-auto"})]})})};export{ot as default};
